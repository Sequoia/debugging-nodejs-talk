<!DOCTYPE html>
<html>
  <head>
    <title>My Awesome Presentation</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);
/*
      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }*/
    </style>
  </head>
  <body>
    <textarea id="source">

class: title
# Debugging Node.js

## Sequoia McDowell

* üåê  http://sequoia.makes.software
* ü¶Ü  @_sequoia
* üìß  sequoia.mcdowell@gmail.com

???

## Welcoming to debugging Node.js!

* I'm Sequoia, find me online at x, y, z
* I've been writing Node.js since v0.3
* Come a long way since then
* Worked in Java for a bit
  * Code hinting
  * Step thru debugging
  * Robust logging
  * *Missed this when I returned to node*

&rarr; Going to talk about how to do this stuff in node.js

---
class: biglist

# Agenda

--

* Logging
???
----
* enabling & disabling logs
* writing to other log systems
--

* IDE Integrations
???
----
* Type hinting
* Linting & problem finding
* Running project tasks
--

* Step-Through Debugging
???
----
* step through debugging
* Breakpoints
--

* Advanced Debugging
???
----
* CPU analysis
* Tracking timing from browser
* heap dump analysis

---

# Logging

???
* What to log
* What tools are available
* Enabling & disabling logging

---
name: console

# The `console` Object
???
* Similar to browser, a couple differences
* stdout, stderr

---
template: console

## `console.log`
--

* aka `console.info`
--

* &rarr; `STDOUT`
--

* `sprintf` style formatting

---

## `console.log` sprintf

```js
server.on('listening', function(){
  
  const pid = process.pid;
  const port = server.address().port || 80;

  console.log('process %d listening on port %d', pid, port);
});
```

???

* It's like SPRINTF

--
----

```no-highlight
$ node server.js
process 53594 listening on 3000
```

---
template:console

## `console.error`
--

* `console.warn`
--

* &rarr; `STDERR`
--

* **Output redirection**
???
* Of course you can redirect stderr output to error loggers
* outputting to stderr directs that output to some logging tools

--> output redirection

---

## `console.log` sprintf

```js
server.on('error', function(e){
  console.error(e);
  //other error handling
});
```

--

```no-highlight
$ node server.js 2>>/var/logs/server.log
$ cat /var/logs/server.log
Port 3000 is already in use
```

???

**Uses standard UNIX idioms!!**

* there are more advanced tools we'll talk about but relying on the OS & standard conventions is great when possible
* No need to reinvent the wheel

---
class:biglist

# The `Error` Object

* `e.message`
* `e.stack`

???

&rarr; Stack only exists if you throw an ERROR!!

---

## ‚ÑπÔ∏è Throw `Error` Objects

--

### ‚ùå

```js
try{
  throw "something went wrong!";
}catch(e){
  console.error(e.stack); // undefined!! :(
}
```

???
* no stack

--

### ‚úÖ

```js
try{
  throw new Error('something went wrong!');
}catch(e){
  console.error(e.stack); 
}                         
// Error: something went wrong!
//     at Object.<anonymous> (/Users/sequoia/tmp/test-app/app.js:16:11)
//     at Module._compile (module.js:541:32)
//     ...
```

???
* With stack trace!

"A JavaScript **exception** is a **value that is thrown** as a result of an invalid operation or as the target of a throw statement. While it is not required that these values are instances of Error or classes which inherit from Error, **all exceptions thrown by Node.js or the JavaScript runtime will be instances of Error**."


---

## ‚ÑπÔ∏è Name Functions

### ‚ùå Anonymous Functions
```js
db.connect(config, function(connection){ /*...*/})
connection.findAll(function(results){ /*...*/})
fs.read(filename, function(err, results){ /*...*/})
```

--

### ‚úÖ Named Functions
```js
db.connect(config, function dbReady(connection){ /*...*/})
Users.findAll(function handleResults(results){ /*...*/})
fs.read(filename, function processFiles(err, results){ /*...*/})
```

---

## ‚ÑπÔ∏è Name Functions

### ‚ùå Anonymous Functions
```no-highlight
Uncaught TypeError: Cannot read property 'name' of undefined
  getUser              @ foo.js:2
  (anonymous function) @ bar.js:71
  (anonymous function) @ bar.js:202
  (anonymous function) @ baz.js:11
  ...
```

--

### ‚úÖ Named Functions
```no-highlight
Uncaught Error:
  getUser              @ foo.js:2
  getItem              @ bar.js:71
  buildDBQuery         @ bar.js:202
  createDatabase       @ baz.js:11
  ...
```
 <!-- .element: class="fragment" -->


---

## ‚ÑπÔ∏è  Use `assert`

### ‚ùå

```js
if(!cfg.host){
  throw new Error('host must be set');
}
if(typeof cfg.port !== 'number'){
  throw new Error('port must be a number');
}
```

--
### ‚úÖ

```js
const assert = require('assert');

assert(cfg.host, 'host must be set');
assert.equal(typeof cfg.port, 'number'), 'port must be a number');
```

???

* Like asserts in java!
* Makes error with stack trace + optional message

---
class:biglist

## System Errors

* `error.code`
* `error.errno`
* `error.syscall`
* `error.path`
* `error.address`
* `error.port`

???
* Regular JS errors but augmented with more info
* From system/OS
* Not all these keys will be present

---

## `error.code`

.biglist[
* Always start with "`E`"
* From OS
* Defined by POSIX error codes
]

???

Other things may be set, depends on OS

--

* `EACCES`
* `EADDRINUSE`
* `ECONNREFUSED`
* `ECONNRESET`
* etc.

---

## `error.code`

```js
fs.readFile(filename, function(err, data){
  if(err){
    if (err.code === 'EACCES'){
      response.statusCode = '403';
      response.statusMessage = 'Access Denied!!';
    }
    if (err.code === 'ENOENT'){
      response.statusCode = '404';
      response.statusMessage = 'Not found';
    }else{
      // something else
      response.statusCode = '500';
      response.statusMessage = 'Something happened... :(';
    }
    return response.end()
  }
  //...
})
```
???
HTTP server example:

* Translate system error code to HTTP error code

---

## Other Console APIs

* **`console.trace`**: Prints stack trace to `STDERR`
* **`console.time`**: Timer
* **`console.timeEnd`**: Timer

--

```js
console.time('db Users query');
db.Users.find(function processUsers(e, users){
  console.timeEnd('db Users query');
  //...
});
```

### Output

```no-highlight
db Users query: 225.438ms
```

???
* Prints to stdout
* We'll look at more useful ways to capture timing info later on

&rarr; improved console.logging

---

# Console Logging

```js
console.log('looking up user {id: %s}', id);
db.Users.find({id: id}, function(e, user){
  console.log('found user %s: %s', user.id, user.name);
})
```
```js
app.get('/posts/:id', function handleIndex(req, res){
  console.log('post %s requested', req.params.id);
})
app.get('/users/:id', function handleIndex(req, res){
  console.log('user %s requested', req.params.id);
})
```
```js
db.on('query', function(query){
  console.log('querying database: %s', query.query);
})
```

???

While you're working you add console statements like this

---

# Console Logging

```js
//...
db.Users.find({id: id}, function(e, user){
  //...
})
```
```js
app.get('/posts/:id', function handleIndex(req, res){
  //...
})
app.get('/users/:id', function handleIndex(req, res){
  //...
})
```
```js
db.on('query', function(query){
  //...
})
```

???
Then you stop working on that stuff so you delete your console.log statements

---

# Console Logging

```js
//console.log('looking up user {id: %s}', id);
db.Users.find({id: id}, function(e, user){
  //console.log('found user %s: %s', user.id, user.name);
})
```
```js
app.get('/posts/:id', function handleIndex(req, res){
  //console.log('post %s requested', req.params.id);
})
app.get('/users/:id', function handleIndex(req, res){
  //console.log('user %s requested', req.params.id);
})
```
```js
db.on('query', function(query){
  //console.log('querying database: %s', query.query);
})
```

???
But later you need them, so you add them back

this time you just **comment them out**

&rarr; There's got to be a better way!

---

# The `debug` module

```no-highlight
$ npm install --save debug
```

--

```js
const debug = require('debug');
const log = debug('my-app');
```

```js
log('test');

setTimeout(function(){
  log('user: %j', { id: 12, name: 'Naomi' });
}, 500)
```

--

----

<pre class="ansi2html">
bash-3.2$ node script.js
</pre>

--

----

<pre class="ansi2html">
bash-3.2$ <span class="b4">DEBUG=*</span> node script.js
--

  <span class="f3"><span class="bold">my-app </span></span>test <span class="f3">+0ms</span>
  <span class="f3"><span class="bold">my-app </span></span>user: {&quot;id&quot;:12,&quot;name&quot;:&quot;Naomi&quot;} <span class="f3">+503ms</span>
</pre>

???

one of the first things I install on a new project

**Note the environmental variable**

---

## Using `debug`

```js
log('looking up user {id: %s}', id);
db.Users.find({id: id}, function(e, user){
  log('found user %s: %s', user.id, user.name);
})
```
```js
app.get('/posts/:id', function handleIndex(req, res){
  log('post %s requested', req.params.id);
})
//...
```
--

<pre class="ansi2html">
bash-3.2$ <span class="b4">DEBUG=my-app</span> script.js
--

  <span class="f3"><span class="bold">my-app </span></span>looking up user {id: 123} <span class="f3">+96ms</span>
  <span class="f3"><span class="bold">my-app </span></span>querying database: SELECT * FROM `Users` WHERE `User.id`=123 <span class="f3">+6ms</span>
  <span class="f3"><span class="bold">my-app </span></span>found user 123: Naomi <span class="f3">+108ms</span>
  <span class="f3"><span class="bold">my-app </span></span>post best-frameworks-2017 requested <span class="f3">+43ms</span>
  <span class="f3"><span class="bold">my-app </span></span>querying database: SELECT * FROM `Posts` WHERE `Post.slug`=&quot;best-frameworks-2017&quot;;<span class="f3">+22ms
</span>
  <span class="f3"><span class="bold">my-app </span></span>user: {&quot;id&quot;:12,&quot;name&quot;:&quot;Naomi&quot;} <span class="f3">+225ms</span>
</pre>

???

* Note timings: time since **last call**
  * `108ms` is time between logging "querying db" and getting result
* Whole application verbose-mode
* We can do better!
* &rarr; **Per-section** debugging

---

```js
const dbLog = debug('my-app:database');
const routeLog = debug('my-app:routes');
const userLog = debug('my-app:users');
```
--
```js
db.Users.find({id: id}, function(e, user){
*  userLog('found user %s: %s', user.id, user.name);
})
app.get('/posts/:id', function handleIndex(req, res){
*  routeLog('post %s requested', req.params.id);
})
db.on('query', function(query){
*  dbLog('querying database: %s', query.query);
})
```

--

<pre class="ansi2html">
bash-3.2$ <span class="b4">DEBUG=my-app:*</span> node script.js          
--

  <span class="f3"><span class="bold">my-app:routes </span></span>user 123 requested <span class="f3">+0ms</span>
  <span class="f6"><span class="bold">my-app:users </span></span>looking up user {id: 123} <span class="f6">+97ms</span>
  <span class="f2"><span class="bold">my-app:database </span></span>querying database: SELECT * FROM `Users` WHERE `User.id`=123 <span class="f2">+7ms</span>
  <span class="f6"><span class="bold">my-app:users </span></span>found user 123: Naomi <span class="f6">+109ms</span>
  <span class="f3"><span class="bold">my-app:routes </span></span>post best-frameworks-2017 requested <span class="f3">+43ms</span>
  <span class="f2"><span class="bold">my-app:database </span></span>querying database: SELECT * FROM `Posts` WHERE `Post.slug`=&quot;best-frameworks-2017&quot;; <span class="f2">+18ms</span>
</pre>

???
What if you're only debugging the Database?

---

### Just Database Logger

<pre class="ansi2html">
bash-3.2$ DEBUG=<span class="b4">my-app:database</span> node script.js          
  <span class="f2"><span class="bold">my-app:database </span></span>querying database: SELECT * FROM `Users` WHERE `User.id`=123 <span class="f2">+7ms</span>
  <span class="f2"><span class="bold">my-app:database </span></span>querying database: SELECT * FROM `Posts` WHERE `Post.slug`=&quot;best-frameworks-2017&quot;; <span class="f2">+18ms</span>
</pre>

--

### Users + Routes

<pre class="ansi2html">
bash-3.2$ DEBUG=<span class="b4">my-app:users,my-app:routes</span> node script.js          
  <span class="f3"><span class="bold">my-app:routes </span></span>user 123 requested <span class="f3">+0ms</span>
  <span class="f6"><span class="bold">my-app:users </span></span>looking up user {id: 123} <span class="f6">+97ms</span>
  <span class="f6"><span class="bold">my-app:users </span></span>found user 123: Naomi <span class="f6">+109ms</span>
  <span class="f3"><span class="bold">my-app:routes </span></span>post best-frameworks-2017 requested <span class="f3">+43ms</span>
</pre>

???

Comma separated

--

### Everything *but* database

<pre class="ansi2html">
bash-3.2$ DEBUG=my-app:*,<span class="b4">-my-app:database</span> node script.js          
  <span class="f3"><span class="bold">my-app:routes </span></span>user 123 requested <span class="f3">+0ms</span>
  <span class="f6"><span class="bold">my-app:users </span></span>looking up user {id: 123} <span class="f6">+97ms</span>
  <span class="f6"><span class="bold">my-app:users </span></span>found user 123: Naomi <span class="f6">+109ms</span>
  <span class="f3"><span class="bold">my-app:routes </span></span>post best-frameworks-2017 requested <span class="f3">+43ms</span>
</pre>

???

Minus to omit

---

## `debug` is widely used
<pre class="ansi2html">
bash-3.2$ <span class="b4">DEBUG=*</span> node script.js          
--

  <span class="f6"><span class="bold">express:application </span></span>set &quot;x-powered-by&quot; to <span class="f3">true<span class="f9"><span class="f6"> +0ms</span></span></span>
  <span class="f6"><span class="bold">express:application </span></span>set &quot;etag&quot; to <span class="f2">'weak'<span class="f9"><span class="f6"> +3ms</span></span></span>

  <span class="f2"><span class="bold">express:router </span></span>use / query<span class="f2"> +1ms</span>
  <span class="f3"><span class="bold">express:router:layer </span></span>new /<span class="f3"> +1ms</span>
  <span class="f2"><span class="bold">express:router </span></span>use / expressInit<span class="f2"> +0ms</span>
  <span class="f3"><span class="bold">express:router:layer </span></span>new /<span class="f3"> +1ms</span>

  <span class="f4"><span class="bold">express:router:route </span></span>new /<span class="f4"> +0ms</span>
  <span class="f3"><span class="bold">express:router:layer </span></span>new /<span class="f3"> +1ms</span>
  <span class="f4"><span class="bold">express:router:route </span></span>get /<span class="f4"> +0ms</span>
  <span class="f3"><span class="bold">express:router:layer </span></span>new /<span class="f3"> +0ms</span>

  <span class="f5"><span class="bold">app:info </span></span>listening on 3030<span class="f5"> +7ms</span>
  <span class="f2"><span class="bold">express:router </span></span>dispatching GET /restaurants/1<span class="f2"> +4s</span>
  <span class="f1"><span class="bold">sqlLib:query </span></span>Executing (default): SELECT `Restaurant`.`id`, `Restaurant`.`name`, `Restaurant`.`founded`, `Restaurant`.`createdAt`, `Restaurant`.`updatedAt`, `Dishes`.`id` AS `Dishes.id`, `Dishes`.`name` AS `Dishes.name`, `Dishes`.`spicy` AS `Dishes.spicy`, `Dishes`.`createdAt` AS `Dishes.createdAt`, `Dishes`.`updatedAt` AS `Dishes.updatedAt`, `Dishes`.`RestaurantId` AS `Dishes.RestaurantId` FROM `Restaurants` AS `Restaurant` LEFT OUTER JOIN `Dishes` AS `Dishes` ON `Restaurant`.`id` = `Dishes`.`RestaurantId` WHERE `Restaurant`.`id` = '1';<span class="f1"> +4s</span>
  <span class="f5"><span class="bold">app:info </span></span>Restaurant Found: "Giotto's"<span class="f5"> +2ms</span>
  <span class="f6"><span class="bold">express:view </span></span>lookup &quot;restaurant_detail.jade&quot;<span class="f6"> +198ms</span>
  <span class="f6"><span class="bold">express:view </span></span>stat &quot;/Users/sequoia/templates/restaurant_detail.jade&quot;<span class="f6"> +0ms</span>
  <span class="f6"><span class="bold">express:view </span></span>render &quot;/Users/sequoia/templates/restaurant_detail.jade&quot;<span class="f6"> +0ms</span>
</pre>

???

Turn on debugger and see what you get!

* Can also use of course app:\*,express:\* etc.

&rarr; This is a node talk but as a side-note: `debug` also works in the browser!

---

## `debug` in The Browser

![debug module used in the browser](img/debug_browser.gif);

---

## More Robust Logging: `winston`

<http://github.com/winstonjs/winston>

--
.biglist[
* Log levels
* Multiple Transports
* Formatting plugins
]

???

* Sometimes you want more robust logging, log levels, external transports etc.
* Winston!

---

## Winston

```no-highlight
npm install winston
```

--

```js
var winston = require('winston');
```

--

```js
winston.log('info', 'Hello distributed log files!');
winston.log('debug','Here is some extra detailed info');

//shorthands:

winston.info('Hello again distributed logs');
winston.debug('Here is more info');
```

--

### Console Output

```no-highlight
info: Hello distributed log files!
info: Hello again distributed logs
```

???

No debug! Log levels

---

## Log Levels

* 0: error
* 1: warn
* 2: info
* 3: verbose
* 4: debug
* 5: silly

???
Reports current level **and below**

--

```js
winston.level = 'info';
winston.level = 'debug';
```

--

```js
winston.level = process.env.LOGLEVEL;
```

```no-highlight
$ LOGLEVEL=info node app.js
```

???
* Set log level
* set programatically

---

## Winston "Transports"

Extensions that send log messages somewhere.

--

```js
winston.add(winston.transports.File, { filename: 'somefile.log' });
winston.remove(winston.transports.Console);
```

???
Example: disabling Console & enabling File

--

## Built in Transports

* Console
* File
* HTTP

???

---

## Additional Winston Transports

* Syslog
* Loggly
* MongoDB
* Redis
* Riak
* Elasticsearch
* SimpleDB
* Mail
* Amazon Kinesis Firehose
* Graylog2
* and many more...

--

----
```no-highlight
$ npm search winston
winston-amon         Winston transport for Amon logging                            =zoramite
winston-amqp         An AMQP transport for winston                                 =kr1sp1n
winston-cassandra    A Cassandra transport for winston                             =jorgebay
winston-couchdb      a couchdb transport for winston                               =alz
winston-express      Express middleware to let you use winston from the browser.   =regality
winston-graylog2     A graylog2 transport for winston                              =smithclay
winston-hbase        A HBase transport for winston                                 =ddude
winston-loggly       A Loggly transport for winston                                =indexzero
winston-mail         A mail transport for winston                                  =wavded
winston-mail2        A mail transport for winston                                  =ivolo
winston-mongodb      A MongoDB transport for winston                               =indexzero
...
```

---

# Interactive Debugging

???

* inspect or alter application state
* see the code execution path ("call stack") that lead to the currently executing line of code, and
* inspect the application state at earlier points on that path

Debuggers are useful when writing your own, original code, but they really show their value when you're working with an unfamiliar codebase. Being able to step through the code execution line by line and function by function can save hours of poring over source code, trying to step through it in your head.

--
class:biglist
* Built-in Debugger
* Chrome Debugger
* IDE Debugger

---
class:bigimage
## Node Built-in Debugger

<pre class="ansi2html">
bash-3.2$ node debug bin/www
</pre>
???
* start the debugger with `node debug` scriptname
--
<pre class="ansi2html">
&lt; Debugger listening on [::]:5858
connecting to 127.0.0.1:5858 ... ok
break in bin/www:7
  5  */
  6 
&gt; 7 <span class="f2">var</span>  app = require('../app');
  8 var debug = require('debug')('test-app:server');
  9 var http = require('http');
</pre>
???
* breaks on first line
* `n` to go to next line
--
<pre class="ansi2html">
n
</pre>
--
<pre class="ansi2html">
break in bin/www:8
  6
  7 var app = require('../app');
> 8 <span class="f2">var</span> debug = require('debug')('test-app:server');
  9 var http = require('http');
 10
</pre>
???
let's try help
--
<pre class="ansi2html">
help
</pre>
--
<pre class="ansi2html">
Commands: run (r), cont (c), next (n), step (s), out (o), backtrace (bt), setBreakpoint (sb), clearBreakpoint (cb),
watch, unwatch, watchers, repl, exec, restart, kill, list, scripts, breakOnException, breakpoints, version
</pre>
???
let's continue
--
<pre class="ansi2html">
c
</pre>
--
<pre class="ansi2html">
< process 92507 listening on 3000
debug> .exit
</pre>
???
**That's enough of that**

&rarr; VSCode

---

## Visual Studio Code

![vscode with debugger running](img/nodejs_debugsession.png)

---

class: biglist

## Visual Studio Code

* From Microsoft
* Written in JavaScript
* Based on Atom editor
* Free / Open Source

???

&rarr; Let's look at setting up

---

## Setting Up The Project

```no-highlight
$ npm install express-generator -g
$ express test-app   # create an application
$ cd test-app        
$ npm install
```

--
```no-highlight
$ npm start
```
![Express homepage](img/express-start.png)

???

Start with a scaffolded express app

---

## Launching VSCode

```no-highlight
$ code .
```

???

From the app directory

--
![Newly opened VSCode](img/vscode-start.png)



---
class:biglist

## Ways to Debug from VS Code

1. Launch from shell and attach
2. Launch from VSCode

???

Either way works, the first is slightly less work

&rarr; We'll start with method 1

---
class:bigimage

## Creating Launch Configurations

![](img/vscode-no-launch-configs.png)

???

1. Click the debug icon
2. No configurations
3. &rarr;Click little gear icon

---
class:bigimage

## Creating Launch Configurations
![](img/vscode-generate-launchconfig.png)
???
Presented with choices, select Node.js

---
class:bigimage

## Creating Launch Configurations
![](img/vscode-default-launchconfig.png)
???
* Now there are two default launch configurations

---

## Default Launch Configurations

```no-highlight
test-app/.vscode/launch.json
```

```js
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Launch Program",
      "program": "${workspaceRoot}/bin/www"
    },
*   {
*     "type": "node",
*     "request": "attach",
*     "name": "Attach to Port",
*     "address": "localhost",
*     "port": 5858
*   }
  ]
}
```

???

* This will attach to a **running** application
* Node.js debugger has the ability to be steered by an external application

---

## Launch App & Attach

--

### 1. Launch with Debug *Server* Listening

<pre class="ansi2html">
$ node --debug bin/www
Debugger listening on [::]:5858
process 2377 listening on 3000
</pre>

???
Server portion is node.js, it's like the debugger from before but **listening for a controller to drive it** (set breakpoints etc.)

--

### 2. Attach Debugger *Client* (VSCode)

![](img/vscode-launch-attach.png)

???
Select "Attach to port" & click green arrow

---

class:bigimage
## Launch App & Attach
![](img/vscode-debug-attach-started.png)

???
Now our debugger is running, note (what you'd expect in a debugger):

* Control bar on top
  * Pause execution
  * Step Over
  * Restart
  * Stop button (with a plug for "detach" because it doesn't actually stop the server)

---
class:bigimage

## Set a Breakpoint
![Setting a breakpoint on index route](img/vscode-set-breakpoint.png)
???
When our homepage is requested, stop code execution

---
class:bigimage

## Load Page in Browser
![Loading the page in the browser](img/load-localhost-3000-breakpoint.png)

???
Page won't actually load, just hangs

---
class:bigimage

## Load Page in Browser
![Hit first Breakpoint, VS Code loaded](img/vscode-hit-first-breakpoint.png)

???

**Execution is now paused**

* Variables Pane:
  * Local variables
  * Request, Response, & Next objects (passed to function)
  * types: **Request is IncomingMessage**, response is ServerResponse. Useful!
  * **This is a big benefit of interactive debugging: discovering stuff you didn't know about your code**
* Watch Expressions
  * None yet
* Call Stack
* Breakpoints


&rarr; Open the request object

---
class:bigimage

## Inspecting Variables

![inspecting the request object](img/vscode-inspect-variables-request.png)

???


---
class:bigimage

## Inspecting Variables

![Request object: headers open](img/vscode-inspect-variables-request-2.png)

???

* Incoming headers object
* HTTP Method
* original URL
* etc.

&rarr; Let's say our issue is in the rendering itself, now we can step into deps

---
class:bigimage
## Stepping Through Code

![Click step into](img/vscode-step-into.png)

---
class:bigimage
## Stepping Through Code

![node_modules/express/lib/response.js](img/vscode-step-into-express-response.png)

???
* Stopped on line 938
* Step over

---
class:bigimage
## Stepping Through Code

![step over button](img/vscode-step-over.png)

???
Click button

---
class:bigimage
## Stepping Through Code

![step over button](img/vscode-stepped-over.png)

???
* Now stopped on line 939
* Step out works as you might expect: goes to return statement and breaks after exiting function

---
class:bigimage

## Editing Variables

![Mover hovered over VSCode variable "options.title"](img/vscode-edit-variable-express.png)

???
Double click it

---
class:bigimage

## Editing Variables

![options.title open for editing](img/vscode-editing-variable-express.png)

???
Double click it

---
class:bigimage

## Editing Variables

![Edited title](img/vscode-edited-variable-express.png)

???
&rarr; Then click "continue"

---

## Editing Variables

![Edited title](img/vscode-edited-variable-express.png)

???
&rarr; Then click "continue"

---

## Editing Variables

![Click continue](img/vscode-continue.png)

???
All this time our browser has been waiting!!

---
class:bigimage

## Editing Variables

![BROWSER with Edited title](img/browser-with-edited-title.png)

???
Changed in all the places the template places that value:
* Title elem
* H1
* in content

&rarr; let's say we want to go back to the caller, we stepped too far in

---
class:bigimage

## Call Stack

![click last stack frame](img/vscode-stack-select.png)

???

Q: Who sees the problem here?

A: **ANONYMOUS FUNCTION**

---
class:bigimage

## Call Stack

![VIEWING last stack frame](img/vscode-stack-back.png)

???

* Now we can see the frame this function was called from
* Note green breakpoint marker: "NOT current location"

&rarr; right click

---
class:bigimage

## Call Stack

![RESTART last stack frame](img/vscode-stack-reload.png)

---
class:bigimage

## Call Stack

![RESTART last stack frame](img/vscode-stack-reloaded.png)

???

* Now we're back in the last frame, we can change things and start execution again

### talk:

* Very powerful
* Step through your application
* Go back
* See who called what etc.

&rarr; Relaunching from shell each time is annoying (also can't catch *startup* errors)
&rarr; Let's set this up to load from VSCode

---

## Default Launch Configurations

```no-highlight
test-app/.vscode/launch.json
```

```js
{
  "version": "0.2.0",
  "configurations": [
*   {
*     "type": "node",
*     "request": "launch",
*     "name": "Launch Program",
*     "program": "${workspaceRoot}/bin/www"
*   },
    {
      "type": "node",
      "request": "attach",
      "name": "Attach to Port",
      "address": "localhost",
      "port": 5858
    }
  ]
}
```

???

* Launch with node
* "program" = startup script
* "workspace root": VScode gives you lots of variables

&rarr; Where did this configuration come from?

---

## `package.json`

```js
{
  "name": "test-app",
  "version": "0.0.0",
  "private": true,
* "scripts": {
*   "start": "node ./bin/www"
* },
  "dependencies": {
    "body-parser": "~1.16.0",
    "cookie-parser": "~1.4.3",
    "debug": "~2.6.0",
    "express": "~4.14.1",
    "jade": "~1.11.0",
    "morgan": "~1.7.0",
    "serve-favicon": "~2.3.2",
    "winston": "^2.3.1"
  }
}
```

???

VSCode will look for startup configurations in your package.json and automatically set them as launch configs

Here we have `npm start` but it will also pickup `package.main` if one exists

&rarr; Kill our running script then launch from VSCode

---
class:bigimage

## Launch from VSCode
![mouse over "launch" button](img/vscode-debug-launch.png)

???
* Now we can launch straight from VSCode

&rarr; Nice because we can break on startup
&rarr; I added a breakpoint

---

## Launch from VSCode
![break on line 1](img/vscode-launch-break-line-one.png)

???

* Also you can (re)launch with F5 making it easy to change & relaunch
* Note that the debug output (console) is now inside vscode

---

## More Launch Configurations

```no-highlight
$ NODE_ENV=development node ./node_modules/.bin/node-lambda run
```

--

```js
{
    "version": "0.3.0",
    "configurations": [
    {
      "name": "Launch",
      "type": "node",
      "request": "launch",
*     "program": "${workspaceRoot}/node_modules/.bin/node-lambda",
      "stopOnEntry": false,
*     "args": ["run"],
*     "cwd": "${workspaceRoot}",
      "preLaunchTask": null,
      "runtimeExecutable": null,
      "runtimeArgs": [
        "--nolazy"
      ],
*     "env": {
*       "NODE_ENV": "development"
*     },
      "externalConsole": false,
      "sourceMaps": false,
      "outDir": null
    }
...
}
```

???

Starting from a utility script in node_modules

* CWD is also important

---

## More Launch Configs

```js
{
    "version": "0.3.0",
    "configurations": [
    {
      "name": "Launch",
      "type": "node",
      "request": "launch",
      "program": "${workspaceRoot}/node_modules/.bin/node-lambda",
*     "stopOnEntry": false,
      "args": ["run"],
      "cwd": "${workspaceRoot}",
*     "preLaunchTask": null,
      "runtimeExecutable": null,
      "runtimeArgs": [
        "--nolazy"
      ],
      "env": {
        "NODE_ENV": "development"
      },
      "externalConsole": false,
*     "sourceMaps": false,
      "outDir": null
    }
...
}
```

???
* Stop on startup immediately
* preLaunchTask (if you have a build task like babel)
  * Won't go into that here
* Sourcemaps!

&rarr; With that setup let's check some of the other features

---

## Break on Exceptions

???

* Checked by default

--

```js
var express = require('express');
var router = express.Router();

*router.use(express.static());

/* GET home page. */
router.get('/', function(req, res, next) {
  res.render('index', { title: 'Express' });
});

module.exports = router;
```

???
adding static middleware....

---

## Break on Exceptions

![](img/vscode-root-path-required.png)

---

## Break on Exceptions

![](img/vscode-root-path-up-stack.png)

???

Also "Break on ALL Exceptions" (even handled ones) &rarr; Be prepared for a lot of noise

---

## Conditional Breakpoints

![](img/vscode-conditional-breakpoints.png)

???
* Enter a condition
  * only admin
  * stop when some program condition is true &rarr; useful for when you have a hard to reproduce case
* hit count: Not so useful here but useful if something is getting called 2x and you only want it called 1x (where is second call coming from?)

More breakpoints I'm not going over!

* Column (for minified code)
* Function name (break when fn by that name is executed)

---

## Watch Expressions

![watch expressions](img/vscode-watch-expressions.png);

???
Any time program is paused, it will show the current value **in the current scope**

* process.pid
* req.query.user

Useful to track change of something through steps, see where it changed

---

## Debug Console

![watch expressions](img/vscode-debug-console.png);

???

* Execute code in the current context
* Also a good way to explore in-memory objects

---
class:biglist
# Chrome Devtools

* Use Chrome as debug "*client*"
* Outside the IDE üôÅ
* More Advanced Debugging Features üòÑ

---
# Node Inspector Installation

<pre class="ansi2html">
$ npm install -g node-inspector
$ node-inspect my-script.js
</pre>

???

Node-inspector is the name of the tool that links chrome devtools to node.js

---
# ~~Node Inspector Installation~~

<pre class="ansi2html">
<strike>$ npm install -g node-inspector</strike>
<strike>$ node-inspect my-script.js</strike>
</pre>

## ‚ú® Bundled with Node (6.3+)‚ú®

<pre class="ansi2html">
$ node --inspect my-script
</pre>

&rarr; Quick review of debug startup methods...

---

## Debug *in Terminal*

<pre class="ansi2html">
$ node <span class="b4">debug</span> my-app.js
< Debugger listening on [::]:5858
connecting to 127.0.0.1:5858 ... ok
break in my-app:7
...
</pre>

--

## Listen for *VSCode* Debugger

<pre class="ansi2html">
$ node <span class="b4">--debug</span> my-app.js
Debugger listening on [::]:5858
[[attach vs-code]]
```
</pre>

--

## Listen for *Chrome* Debugger

<pre class="ansi2html">
$ node <span class="b4">--inspect</span> my-app.js
Debugger listening on port 9229.
Warning: This is an experimental feature and could change at any time.
To start debugging, open the following URL in Chrome:
    chrome-devtools://devtools/remote/serve_file/@521e5b7e2b7cc66b4006a8a54cb9c4e57494a5ef/inspector.html?experiments=true&v8only=true&ws=localhost:9229/node
</pre>

---

# Chrome Debugger

<pre class="ansi2html">
$ node <span class="b4">--inspect</span> my-app.js
Debugger listening on port 9229.
Warning: This is an experimental feature and could change at any time.
To start debugging, open the following URL in Chrome:
    chrome-devtools://devtools/remote/serve_file/@521e5b7e2b7cc66b4006a8a54cb9c4e57494a5ef/inspector.html?experiments=true&v8only=true&ws=localhost:9229/node
</pre>

---

# Chrome Debugger

![chrome debugger](img/chrome-debugger.png)

???

&rarr; Why would you use this instead?

---
class:biglist

## Advantages (over VSCode) ‚úÖ

* CPU profiling
* Heap snapshots & analysis 
* Don't need to use VS Code

--

## Disadvantages ‚ùå

* Outside your IDE
* Some non-node related cruft

--

## ‚úÖ‚úÖ‚úÖ Use both!

???

They do different things

Use VS-Code for dev, chrome when you need more advanced debugging

A

&rarr; breakpoints, watch expressions etc. are about the same (vscode has a slight edge in places)
&rarr; **Profiling** is what chrome inspector is good for

---

## Chrome: Pro

    </textarea>
    <script src="/lib/remark.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create();
    </script>
  </body>
</html>